<?php
	require_once 'db.php';
?>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Cross Site Request Forgery (CSRF)</title>
<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/bootstrap-rtl.min.css">
<link rel="stylesheet" href="css/font-awesome.min.css">
<link rel="stylesheet" href="css/style.css">
<style>
input{
	font-family:arial;
}
</style>
</head>
<body>
	<div class="container">

	<?php require_once 'template/header.php'; ?>

		<div class="body text-center" style="padding-top:40px;">
			<?php
				$isLoginOk = false;
				$user = isset($_POST['user']) ? htmlentities($_POST['user'],ENT_QUOTES,'UTF-8') : '';
				$pass = isset($_POST['pass']) ? htmlentities($_POST['pass'],ENT_QUOTES,'UTF-8') : '';
				if(isset($_POST['btn_login']))
				{
					$q = "SELECT * FROM users WHERE user = '$user' AND pass = '$pass'";
					$r = mysqli_query($db,$q);
					if($r->num_rows > 0)
					{
						$isLoginOk = true;
					}
					else
					{
						$isLoginOk = false;
						print '<div class="alert alert-danger text-center">
							نام کاربری یا کلمه عبور صحیح نمیباشد.
						</div>';
					}
				}	
				if(isset($_POST['btn_pwd']))
				{
					$isLoginOk = true;
					$q = "UPDATE users SET pass = '$pass' WHERE user = '$user'";
					$r = mysqli_query($db,$q);
					print '<div class="alert alert-success text-center">
						با موفقیت انجام شد .
					</div>';
				}				
				if($isLoginOk)	
				{
					?>
						<h4>تغییر پسورد</h4>
						<br>
						<form class="form-horizontal" method="post" action=""  autocomplete="off">
						  <input type="hidden" name="user" value="<?php print $user; ?>">
						  <div class="form-group">
							<label for="pass" class="col-sm-2 control-label">
								رمز عبور : 
							</label>
							<div class="col-sm-10">
							  <input type="password" class="form-control" id="pass" name="pass">
							</div>
						  </div>
						  <div class="form-group">
							<div class="col-sm-offset-2 col-sm-10">
							  <button name="btn_pwd" type="submit" class="btn btn-success">
									تغییر رمز عبور 
							  </button>
							</div>
						  </div>
						</form>					
					<?php
				}
				else
				{
			?>		
					<h4>ورود به سیستم</h4>
					<br>
					<form class="form-horizontal" method="post" action="" autocomplete="off">
					  <div class="form-group">
						<label for="user" class="col-sm-2 control-label">
							نام کاربری
						</label>
						<div class="col-sm-10">
						  <input type="text" class="form-control" id="user" name="user">
						</div>
					  </div>
					  <div class="form-group">
						<label for="pass" class="col-sm-2 control-label">
							رمز عبور : 
						</label>
						<div class="col-sm-10">
						  <input type="password" class="form-control" id="pass" name="pass">
						</div>
					  </div>
					  <div class="form-group">
						<div class="col-sm-offset-2 col-sm-10">
						  <button name="btn_login" type="submit" class="btn btn-success">ورود</button>
						</div>
					  </div>
					</form>
				<?php
				}
				?>
		</div>
	</div>
</body>
</html>
